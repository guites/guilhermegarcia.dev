<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="https://guilhermegarcia.dev/images/favicon.png" />
<title>Comparando json na linha de comando | Blog do Guilherme</title>
<meta name="title" content="Comparando json na linha de comando" />
<meta name="description" content="vamos usar o vimdiff e o jq para comparar arquivos json independente da formatação" />
<meta name="keywords" content="jq,vim,cli,português," />


<meta property="og:title" content="Comparando json na linha de comando" />
<meta property="og:description" content="vamos usar o vimdiff e o jq para comparar arquivos json independente da formatação" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://guilhermegarcia.dev/blog/comparando-json-na-linha-de-comando/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-10-25T22:50:34-03:00" />
<meta property="article:modified_time" content="2022-10-25T22:50:34-03:00" /><meta property="og:site_name" content="Blog do Guilherme" />




<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Comparando json na linha de comando"/>
<meta name="twitter:description" content="vamos usar o vimdiff e o jq para comparar arquivos json independente da formatação"/>



<meta itemprop="name" content="Comparando json na linha de comando">
<meta itemprop="description" content="vamos usar o vimdiff e o jq para comparar arquivos json independente da formatação"><meta itemprop="datePublished" content="2022-10-25T22:50:34-03:00" />
<meta itemprop="dateModified" content="2022-10-25T22:50:34-03:00" />
<meta itemprop="wordCount" content="945">
<meta itemprop="keywords" content="jq,vim,cli,português," />
<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  body {
    font-family: Verdana, sans-serif;
    margin: auto;
    padding: 20px;
    max-width: 720px;
    text-align: left;
    background-color: #fff;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: #444;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  strong,
  b {
    color: #222;
  }

  a {
    color: #3273dc;
     
  }

  .title {
    text-decoration: none;
    border: 0;
  }

  .title span {
    font-weight: 400;
  }

  nav a {
    margin-right: 10px;
  }

  textarea {
    width: 100%;
    font-size: 16px;
  }

  input {
    font-size: 16px;
  }

  content {
    line-height: 1.6;
  }

  table {
    width: 100%;
  }

  img {
    max-width: 100%;
  }

  code {
    padding: 2px 5px;
    background-color: #f2f2f2;
  }

  pre code {
    color: #222;
    display: block;
    padding: 20px;
    white-space: pre-wrap;
    font-size: 14px;
    overflow-x: auto;
  }

  div.highlight pre {
    background-color: initial;
    color: initial;
  }

  div.highlight code {
    background-color: unset;
    color: unset;
  }

  blockquote {
    border-left: 1px solid #999;
    color: #222;
    padding-left: 20px;
    font-style: italic;
  }

  footer {
    padding: 25px;
    text-align: center;
  }

  .helptext {
    color: #777;
    font-size: small;
  }

  .errorlist {
    color: #eba613;
    font-size: small;
  }

   
  ul.blog-posts {
    list-style-type: none;
    padding: unset;
  }

  ul.blog-posts li {
    display: flex;
  }

  ul.blog-posts li span {
    flex: 0 0 130px;
  }

  ul.blog-posts li a:visited {
    color: #8b6fcb;
  }

  aside {
    margin: 15px 5px;
    padding: 5px 10px;
    border: 1px dashed;
    text-align: justify;
    hyphens: auto;
  }

  aside::before {
    content: " ᶘ ᵒᴥᵒᶅ ";
    margin-right: 5px;
  }

  aside.warning {
    border-color: #ffbb00;
    background-color: rgb(255, 249, 231);
  }

  aside.warning::before {
    color: #ffbb00;
  }

  @media (prefers-color-scheme: dark) {
    body {
      background-color: #333;
      color: #ddd;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    strong,
    b {
      color: #eee;
    }

    a {
      color: #8cc2dd;
    }

    code {
      background-color: #777;
    }

    pre code {
      color: #ddd;
    }

    blockquote {
      color: #ccc;
    }

    aside.warning {
        background-color: transparent;
    }

    textarea,
    input {
      background-color: #252525;
      color: #ddd;
    }

    .helptext {
      color: #aaa;
    }
  }
</style>

</head>

<body>
  <header><a href="/" class="title">
  <h2>Blog do Guilherme</h2>
</a>
<nav><a href="/">Home</a>


<a href="/blog">Blog</a>

<a href="/links">Links</a>
<a href="/art">Art</a>
</nav>
</header>
  <main>

<h1>Comparando json na linha de comando</h1>
<p>
  <i>
    <time datetime='2022-10-25' pubdate>
      25 Oct, 2022
    </time>
  </i>
</p>


  <nav id="TableOfContents">
  <ul>
    <li><a href="#payloads-de-exemplo">Payloads de exemplo</a></li>
    <li><a href="#comparando-no-olho">Comparando no olho</a></li>
    <li><a href="#programas-de-comparação-de-texto">Programas de comparação de texto</a></li>
    <li><a href="#ajustando-a-formatação">Ajustando a formatação</a></li>
    <li><a href="#juntando-tudo-em-jsondiff">Juntando tudo em <code>jsondiff</code></a></li>
    <li><a href="#evitando-erros-em-jsondiff">Evitando erros em jsondiff</a></li>
    <li><a href="#jsondiff-à-prova-de-erros"><code>jsondiff</code> à prova de erros</a></li>
    <li><a href="#referências">Referências</a></li>
  </ul>
</nav>

<content>
  <p>Comparando json na linha de comando</p>
<p><abbr title="muito grande;nem li">mg;nl</abbr>: vamos usar o <a href="https://vimdoc.sourceforge.net/htmldoc/diff.html">vimdiff</a> e o <a href="https://stedolan.github.io/jq/">jq</a> para comparar arquivos json independente da formatação.</p>
<p>Comparar arquivos json parecidos pode ser complicado. Muitas vezes os arquivos foram formatados com espaçamentos diferentes, ou a diferença não ocorre no mesmo nível hierarquico.</p>
<p>Vamos criar um script simples pra comparar arquivos json diretamente pelo terminal, usando o programa <code>jq</code> e o <code>vimdiff</code>.</p>
<p>Vamos ver também como preparar um script bash pra lidar com erros conhecidos, como arquivos com json inválido ou de outro formato.</p>
<aside>Os exemplos usados foram gerados usando <a href="https://json-generator.com">https://json-generator.com</a></aside>
<hr/>
<h2 id="payloads-de-exemplo">Payloads de exemplo</h2>
<p>Vamos testar a comparação de dois arquivos json, <a href="./payload1.json">payload1.json</a> e <a href="./payload2.json">payload2.json</a>.</p>
<aside>Clique no nome dos arquivos pra fazer download.</aside>
<h2 id="comparando-no-olho">Comparando no olho</h2>
<p>Você pode fazer do jeito manual, abrindo seus arquivos e comparando no olho:</p>
<pre><code># substitua firefox pelo seu visualizador/editor favorito

firefox payload1.json payload2.json
</code></pre>
<p><img src="./firefox-compare.png" alt="Usando um visualizador para encontrar diferenças" title="Usando um visualizadoer para encontrar diferenças"></p>
<p>Logo de cara, algumas dúvidas surgem: quais chaves o primeiro arquivo tem, que o segundo não? Em quais índices do array?</p>
<p>Vamos utilizar um programa mais propício.</p>
<h2 id="programas-de-comparação-de-texto">Programas de comparação de texto</h2>
<p>Que tal usar o <code>diff</code>?</p>
<pre><code>    diff payload1.json payload2.json
</code></pre>
<p><img src="./diff-compare.png" alt="Comparando com diff" title="Comparando com diff"></p>
<p>Opa, parece que todas as linhas são diferentes?</p>
<p>Vamos investigar com <code>vimdiff</code></p>
<pre><code>    vimdiff payload1.json payload2.json
</code></pre>
<p><img src="./vimdiff-compare.png" alt="Investigando com vimdiff" title="Investigando com vimdiff"></p>
<p>Ah é, o espaçamento é diferente nos dois arquivos&hellip;</p>
<aside>Você precisa escrever `:qa` pra fechar o vimdiff!</aside>
<h2 id="ajustando-a-formatação">Ajustando a formatação</h2>
<p>Vamos utilizar o <a href="https://stedolan.github.io/jq/">jq</a>, um utilitário que permite manipular arquivos json pela linha de comandos.</p>
<pre><code>    sudo apt-get install jq
</code></pre>
<p>Ele tem uma opção que resolve o problema das chaves faltantes, <code>-S</code> ou <code>--sort-keys</code>, que ordena as propriedades de todos os objetos.</p>
<pre><code>    jq -S . payload1.json
</code></pre>
<p><img src="./jq-output.png" alt="json formatado usando jq" title="json formatado usando jq"></p>
<p>Repare que ele também ajusta os espaçamentos.</p>
<h2 id="juntando-tudo-em-jsondiff">Juntando tudo em <code>jsondiff</code></h2>
<p>Vamos criar uma função que une a formatação de <code>jq</code> com a comparação de <code>vimdiff</code>, usando a <a href="https://www.gnu.org/software/bash/manual/html_node/Command-Substitution.html">substituição de comandos</a> do bash.</p>
<pre><code>    vimdiff &lt;(jq -S . payload1.json) &lt;(jq -S . payload2.json)
</code></pre>
<p><img src="./vimdiff-jq.png" alt="Diferença com a formatação correta" title="Diferença com a formatação correta"></p>
<p>Bem melhor!</p>
<p>Podemos generalizar o comando em uma função. Você pode adicioná-la diretamente no seu arquivo <code>~/.bash_aliases</code>.</p>
<pre><code>    function jsondiff() {
        vimdiff &lt;(jq -S . $1) &lt;(jq -S . $2)
    }
    alias ,jsondiff=jsondiff
</code></pre>
<p>Onde <code>$1</code> e <code>$2</code> fazem referência ao primeiro e segundo argumentos passados na função, respectivamente.</p>
<p>Depois de editar o <code>~/.bash_aliases</code>, lembre de rodar</p>
<pre><code>    source ~/.bash_aliases
</code></pre>
<p>Pra alteração surtir efeito na sessão atual.</p>
<p>Você pode chamar a nova função com</p>
<pre><code>    ,jsondiff payload1.json payload2.json
</code></pre>
<aside>A vírgula antes do nome da função é opcional, mas é uma forma fácil de lembrar o nome das suas funções customizadas. Basta digitar "," no terminal e apertar tab duas vezes :-) . </aside>
<h2 id="evitando-erros-em-jsondiff">Evitando erros em jsondiff</h2>
<p>No formato atual, caso você passe como argumento um arquivo com json inválido (ou arquivo de outro formato), erros estranhos podem ocorrer.</p>
<p>Salve o json abaixo num arquivo chamado <a href="./invalid.json">invalid.json</a>:</p>
<pre><code>    [
      {
        &quot;_id&quot;: &quot;63587aa3e14b988f7c6c2aff&quot;,
        &quot;index&quot;: 0,
        &quot;guid&quot;: &quot;884e6062-cfc2-4f57-a82c-081d6d5eac83&quot;,
        &quot;isActive&quot;: false,
      }
    ]
</code></pre>
<aside>O formato json não permite a vírgula à direita na última propriedade de um objeto.</aside>
<p>E tente utilizá-lo como parâmetro no <code>jsondiff</code></p>
<pre><code>    ,jsondiff payload1.json invalid.json
</code></pre>
<p><img src="./error-case.png" alt="jsondiff em estado de erro" title="jsondiff em estado de erro"></p>
<p>Repare que a tela da direita está vazia.</p>
<p>Se você tentar utilizar o <code>jq</code> diretamente no invalid.json,</p>
<pre><code>    jq -S . invalid.json
</code></pre>
<p>Vai ver o seguinte output:</p>
<pre><code>    parse error: Expected another key-value pair at line 7, column 3
</code></pre>
<p>Por sorte, o <code>jq</code> respeita a tradição unix de reservar o código de saída 0 para programas que rodarem com sucesso.</p>
<p>Um código de saída diferente de 0, portanto, indica que ocorreu um erro. No nosso caso, qualquer tipo de erro deve impedir que o programa prossiga.</p>
<p>Vamos criar um teste, que vai ser rodado antes da lógica do <code>jsondiff</code>.</p>
<p>Primeiro, rodamos o <code>jq</code>:</p>
<pre><code>    jq . invalid.json &gt;/dev/null 2&gt;&amp;1
</code></pre>
<aside>A parte `>/dev/null 2>&1` tem duas funções: `2>&1` redireciona as saídas de erro pro canal normal \(stderr into stdout\), e `>dev/null` descarta toda a saída do canal normal. Basicamente, jogamos fora qualquer output da função.</aside>
<p>Depois, verificamos o código de saída, utilizando a variável reservada <code>$?</code>. Experimenta printá-la:</p>
<pre><code>    jq . invalid.json &gt;/dev/null 2&gt;&amp;1
    echo $?
</code></pre>
<p>Verifique um output no formato abaixo:</p>
<pre><code>    guites@local:/tmp$ jq -S . invalid.json
    parse error: Expected another key-value pair at line 7, column 3
    guites@local:/tmp$ echo $?
    4 # &lt;!-- código de erro diferente de 0 !
</code></pre>
<p>Vamos colocar esse teste num bloco <code>if else</code>:</p>
<pre><code>if ! jq . $1 &gt;/dev/null 2&gt;&amp;1; then
    echo &quot;$1 contains invalid json data.&quot;
fi
</code></pre>
<aside>No mundo unix, um output 0 é considerado `true`, enquanto qualquer outro número é visto como `false`.</aside>
<p>Podemos encapsular esse teste em uma função separada</p>
<pre><code>    function validatejson() {
        if ! jq . $1 &gt;/dev/null 2&gt;&amp;1; then
            echo &quot;$1 contains invalid json data.&quot;
            return 1
        fi
        return 0
    }
</code></pre>
<h2 id="jsondiff-à-prova-de-erros"><code>jsondiff</code> à prova de erros</h2>
<p>Utilizando a verificação, vamos adaptar nosso método principal, o <code>jsondiff</code>, diretamente no arquivo <code>~/.bash_aliases</code></p>
<pre><code>    function validatejson() {
        if ! jq . $1 &gt;/dev/null 2&gt;&amp;1; then
            echo &quot;$1 contains invalid json data.&quot;
            return 1
        fi
        return 0
    }

    function jsondiff() {
        validatejson $1 || return 1
        validatejson $2 || return 1
        vimdiff &lt;(jq -S . $1) &lt;(jq -S . $2)
    }

    alias ,jsondiff=jsondiff
</code></pre>
<aside>O uso do `if ! <comando>` é uma forma enxuta de verificar se o código de saída de um comando é diferente de zero.</aside>
<p>Caso o arquivo json passado de argumento seja inválido, o método <code>validatejson()</code> vai retornar 1, que é considerado um valor falso, e caímos no lado direito dos operadores OR (<code>||</code>) utilizados nas duas primeiras linhas da função <code>jsondiff</code>.</p>
<aside>Lembre de rodar `source ~/.bash_aliases` sempre que modificar o arquivo.</aside>
<p>O <code>return 1</code> cumpre dois objetivos: finaliza a função antes de entrarmos na parte principal, e define o código de saída, para mantermos o padrão unix.</p>
<p>Vamos testar:</p>
<pre><code>    ,jsondiff payload1.json invalid.json
    echo $?
</code></pre>
<p>Verifique o output no formato:</p>
<pre><code>    guites@local:/tmp$ ,jsondiff payload1.json invalid.json
    invalid.json contains invalid json data.
    guites@local:/tmp$ echo $?
    1
</code></pre>
<p>Abraço!</p>
<h2 id="referências">Referências</h2>
<ol>
<li><a href="https://stackoverflow.com/a/46955018/14427854">https://stackoverflow.com/a/46955018/14427854</a></li>
<li><a href="https://stackoverflow.com/a/37175540/14427854">https://stackoverflow.com/a/37175540/14427854</a></li>
<li><a href="https://www.jsondiff.com/">https://www.jsondiff.com/</a></li>
</ol>

</content>
<p>
  
  <a href="https://guilhermegarcia.dev/blog/jq/">#jq</a>
  
  <a href="https://guilhermegarcia.dev/blog/vim/">#vim</a>
  
  <a href="https://guilhermegarcia.dev/blog/cli/">#cli</a>
  
  <a href="https://guilhermegarcia.dev/blog/portugu%C3%AAs/">#português</a>
  
</p>

  </main>
  <footer>
</footer>

    
</body>

</html>
